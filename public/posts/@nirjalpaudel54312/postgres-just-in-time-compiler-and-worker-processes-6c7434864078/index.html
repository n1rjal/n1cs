<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>Postgres Just In Time Compiler and Worker Processes :: Blogs | Nirjal Paudel  - Example site for hugo-theme-tailwind</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Both Just In Time compiler or JIT and worker processes could be news to you. By the end of this article, you would be able to understand the picture I have provided.
For this article, I have created a couple of Postgres tables with huge rows, each of the rows has a relationship with another table. The relationship between them is many-to-one. One of the tables is a product and the other table is a store."
/>
<meta
  name="keywords"
  content="hugo, tailwind, tailwindcss, hugo theme, hugo theme tailwind"
/>
<meta name="robots" content="noodp" />
<meta property="og:url" content="http://localhost:1313/posts/@nirjalpaudel54312/postgres-just-in-time-compiler-and-worker-processes-6c7434864078/">
  <meta property="og:site_name" content="Blogs | Nirjal Paudel ">
  <meta property="og:title" content="Postgres Just In Time Compiler and Worker Processes">
  <meta property="og:description" content="Both Just In Time compiler or JIT and worker processes could be news to you. By the end of this article, you would be able to understand…">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-06-28T05:54:08+00:00">
    <meta property="article:modified_time" content="2023-06-28T05:54:08+00:00">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Postgres Just In Time Compiler and Worker Processes">
  <meta name="twitter:description" content="Both Just In Time compiler or JIT and worker processes could be news to you. By the end of this article, you would be able to understand…">


<link rel="canonical" href="http://localhost:1313/posts/@nirjalpaudel54312/postgres-just-in-time-compiler-and-worker-processes-6c7434864078/" />

<link rel="shortcut icon" href="/favicon.ico" />
<link rel="stylesheet" href="/css/index.4573e47dcfff49700db206601116cd2f48db1912c244b1d0b312713d4ca4a32e.css">





  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-EW6BB7P3VN"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-EW6BB7P3VN');
        }
      </script>
    
  






  
  

</head>
<body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800">
    
<div class="fixed right-0 top-0 z-50 flex items-center justify-center bg-gray-200 p-2 text-sm uppercase text-black sm:bg-red-200 md:bg-yellow-200 lg:bg-green-200 xl:bg-blue-200 2xl:bg-pink-200">
  <span class="block sm:hidden">all</span>
  <span class="hidden sm:block md:hidden">sm</span>
  <span class="hidden md:block lg:hidden">md</span>
  <span class="hidden lg:block xl:hidden">lg</span>
  <span class="hidden xl:block 2xl:hidden">xl</span>
  <span class="hidden 2xl:block">2xl</span>
</div>

  <header class="flex flex-none justify-center z-10">
    <div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3">
  <div class="flex-none ml-2 md:ml-0">
    <a href="/" class="">
      <img class="h-12 w-12 rounded-full object-cover bg-gray-100" src="/logo.webp" alt="logo">
    </a>
  </div>
  <div class="flex-1"></div>
  <div class="flex-none">
    



<nav class="h-full static">
  <button id="navbar-menu-toggle" type="button" class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls="navbar-menu" aria-expanded="false">
    <span class="sr-only">Open main menu</span>
    <i class="w-8 h-8">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 6l16 0" />
  <path d="M4 12l16 0" />
  <path d="M4 18l16 0" />
</svg>

    </i>
  </button>
  <div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id="navbar-menu">
    <ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-sm md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5">
    
        <li id="about" class="">
          <a class="block px-3 py-3 hover:text-emerald-600"
            href="" title="About">About</a>
        </li>
      
    
        <li id="post" class="">
          <a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600"
            href="/posts/" title="Post">Post</a>
        </li>
      
    
    </ul>
  </div>
</nav>


  </div>
  
  <div class="flex-none mx-1"></div>
  
  <div class="flex-none md:hidden">
    <a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
      <span class="sr-only">Search</span>
      <i class="w-8 h-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
    <path d="M21 21l-6 -6" />
</svg>

      </i>
    </a>
  </div>
  <div class="darkmode-toggle flex flex-none mr-2 md:mr-0">
    <label for="darkmode-toggle" class="flex items-center px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode">
      <input name="darkmode-toggle" id="darkmode-toggle" type="checkbox" class="sr-only peer" aria-label="Toggle dark mode">
      <div class="group flex flex-row gap-1 justify-center h-8 px-1 rounded-full bg-white dark:bg-gray-700">
        <i class="h-6 w-6 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:group-[]:invisible">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
   <path d="M12 5l0 .01"></path>
   <path d="M17 7l0 .01"></path>
   <path d="M19 12l0 .01"></path>
   <path d="M17 17l0 .01"></path>
   <path d="M12 19l0 .01"></path>
   <path d="M7 17l0 .01"></path>
   <path d="M5 12l0 .01"></path>
   <path d="M7 7l0 .01"></path>
</svg>

        </i>
        <i class="h-6 w-6 flex-none rounded-full place-self-center invisible peer-checked:group-[]:visible">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
   <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
   <path d="M19 11h2m-1 -1v2"></path>
</svg>

        </i>
      </div>
    </label>
  </div>
</div>

  </header>
  <main class="flex flex-auto justify-center">
    
<div class="w-full max-w-4xl lg:max-w-5xl">
  <div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700">
    <div>
      <a href="/posts/@nirjalpaudel54312/postgres-just-in-time-compiler-and-worker-processes-6c7434864078/">
        
      </a>
    </div>
    <div class="flex flex-col gap-y-3 p-6">
      <h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100">
        <a href="/posts/@nirjalpaudel54312/postgres-just-in-time-compiler-and-worker-processes-6c7434864078/">Postgres Just In Time Compiler and Worker Processes</a>
      </h1>

      
      <h2 class="my-4 text-large text-slate-600 dark:text-slate-300">
        Both Just In Time compiler or JIT and worker processes could be news to you. By the end of this article, you would be able to understand…
      </h2>
      
      


      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  
  
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"></path>
   <path d="M16 3v4"></path>
   <path d="M8 3v4"></path>
   <path d="M4 11h16"></path>
   <path d="M11 15h1"></path>
   <path d="M12 15v3"></path>
</svg>

    </i>
    <time datetime="2023-06-28T05:54:08&#43;00:00">
      2023-06-28
    </time>
  </div>

  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M6.5 7h11"></path>
   <path d="M6 20v-2a6 6 0 1 1 12 0v2a1 1 0 0 1 -1 1h-10a1 1 0 0 1 -1 -1z"></path>
   <path d="M6 4v2a6 6 0 1 0 12 0v-2a1 1 0 0 0 -1 -1h-10a1 1 0 0 0 -1 1z"></path>
</svg>

    </i>
    <span>
      5 minutes to read
    </span>
  </div>
</div>


      
        
        <section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6">
          <h2>Table of Contents</h2>
          <aside><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#where-clause-andcount">WHERE clause and Count:</a></li>
        <li><a href="#whats-in-thepicture">Whats in the picture</a></li>
        <li><a href="#big-but">BIG BUT</a></li>
      </ul>
    </li>
  </ul>
</nav></aside>
        </section>
        
      

      <article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content">
        <p>Both Just In Time compiler or JIT and worker processes could be news to you. By the end of this article, you would be able to understand the picture I have provided.</p>
<p><div class="not-prose">
<figure>
    <img src="/Users/nirjalpaudel/Downloads/me/posts/md_1717232175977/img/0__IOAxGZtt5VJcHT__v.jpg"
      alt="" 
      loading="lazy"
    >
  </figure></div>
</p>
<p>For this article, I have created a couple of Postgres tables with huge rows, each of the rows has a relationship with another table. The relationship between them is many-to-one. One of the tables is a product and the other table is a store. Many products have one store referenced by the <code>store_id</code> column. Here is a rough command for SQL `CREATE TABLE` statement</p>
<p>CREATE TABLE store (<br>
id SERIAL PRIMARY KEY,<br>
name VARCHAR(255),<br>
address VARCHAR(255),<br>
phone_number VARCHAR(15)<br>
);</p>
<p>CREATE TABLE product (<br>
id SERIAL PRIMARY KEY,<br>
name VARCHAR(255),<br>
price DECIMAL(10,2),<br>
description TEXT,<br>
store_id INT,<br>
FOREIGN KEY (store_id) REFERENCES store (id)<br>
);</p>
<p>I have around 29k stores and around 12 million products. Here is the count of the both</p>
<p><div class="not-prose">
<figure>
    <img src="/Users/nirjalpaudel/Downloads/me/posts/md_1717232175977/img/0__wwdEf4Q__Cr2jRDe9.jpg"
      alt="" 
      loading="lazy"
    >
  </figure></div>

<div class="not-prose">
<figure>
    <img src="/Users/nirjalpaudel/Downloads/me/posts/md_1717232175977/img/0__fMmJZzvtpc0TTGz9.jpg"
      alt="" 
      loading="lazy"
    >
  </figure></div>
</p>
<p>I haven’t placed any indexing structure for the product table. Now let’s interact with the product table.</p>
<h3 id="where-clause-andcount">WHERE clause and Count:</h3>
<p>EXPLAIN ANALYSE SELECT COUNT(*) FROM &ldquo;product&rdquo;<br>
WHERE &ldquo;price&rdquo; &lt; 10;</p>
<p>The result of <code>EXPLAIN ANALYZE</code> shows the following info</p>
<p><div class="not-prose">
<figure>
    <img src="/Users/nirjalpaudel/Downloads/me/posts/md_1717232175977/img/0__ST4__Mgte__z1JpRl__.jpg"
      alt="" 
      loading="lazy"
    >
  </figure></div>
</p>
<h4 id="planning-stagejit">Planning stage/JIT:</h4>
<p>The planning stage for the command used the Just In Time compilation. I think every analytical serverless function should use this. Due to JIT compilation, the planning phase time is almost doubled.</p>
<p>Just In Time Compilation (JIT)</p>
<p>Suggestions:</p>
<ol>
<li>Use JIT for analytical queries.</li>
<li>Use JIT for complex sorting queries.</li>
</ol>
<h4 id="execution-stageworker-process">Execution stage/Worker process:</h4>
<p>The execution stage of the query is executed using 2 workers, each of the worker processes scans the table from opposite ends. Each worker is filtering the rows and count results were gathered and a final aggregation was done to get the final count.</p>
<p>On worker process:</p>
<p>The worker process strategy used spawns 2 process that parallel scans the product and returns the matching rows, here the worker uses the <code>gather</code> node and has done the here partial and the final aggregation used is the <code>COUNT</code> aggregation. Here is a graphic that can help you understand the working principle.</p>
<h3 id="whats-in-thepicture">Whats in the picture</h3>
<p><div class="not-prose">
<figure>
    <img src="/Users/nirjalpaudel/Downloads/me/posts/md_1717232175977/img/0____E2__Ug2Sr__O8TzNQ.jpg"
      alt="" 
      loading="lazy"
    >
  </figure></div>
</p>
<p>I hope you can clearly understand the picture now, but here are the steps involved.</p>
<ol>
<li>The parent process spawns two processes.</li>
<li>Two processes work from either end of the table</li>
<li>The processing or scanning takes place in our case, it scans via the native CPU code generated due to JIT compilation.</li>
<li>The result is partially aggregated meaning total count is generated.</li>
<li>The count is handed over to the parent process by the worker process.</li>
<li>The 2 worker processes are killed and their result is combined and the output is given to the user.</li>
</ol>
<p>Now you might be wondering what if we increase the total number of workers in the query, let’s do that. Note that this will increase the execution speed of the query but as more processes are used, it will use more memory. Lets me increase the <code>max_parallel_workers</code> and <code>max_parallel_workers_per_gather</code> parameter to and 4 respectively to get more workers to do the task. Learn about them more here.</p>
<p><a href="https://www.postgresql.org/docs/current/how-parallel-query-works.html" target="_blank" rel="noopener">How does the Postgres parallel worker work</a>
</p>
<p>My PC is 8 core CPU PC and my CS knowledge says that my computer shouldn’t lag till 8 worker processes. Managing process is also time-consuming as launching and killing a process is a time-consuming and expensive time as well. But hey, I am postgres with docker and other background apps are running simultaneously as well. So leaving the theory aside lets make the hands dirty.</p>
<p>I ran the following query</p>
<p>-- the value x is the total worker allowed<br>
SET max_parallel_workers = x;<br>
SET max_parallel_workers_per_gather = x;<br>
EXPLAIN ANALYSE SELECT COUNT(*) FROM &ldquo;product&rdquo; WHERE &ldquo;price&rdquo; &lt; 10</p>
<p>Upon running the query I got the following results</p>
<p><div class="not-prose">
<figure>
    <img src="/Users/nirjalpaudel/Downloads/me/posts/md_1717232175977/img/1__qnI3tIP97fDsVrAN______J2w.png"
      alt="" 
      loading="lazy"
    >
  </figure></div>
</p>
<p>Postgres query planner is a clever piece of tool and it detected that the execution time was not going to be much better after 5 worker processes and stopped spawning more worker processes when it reached the value of x greater than 5. Even when I was allowed to go more than 5 workers per execution, I didn’t do that and insisted on using 5 worker processes.</p>
<h3 id="big-but">BIG BUT</h3>
<p>Here’s a big but for y’all. The query I used is pretty simple, right? count the total, so let me spice things up a little bit more with the following query.</p>
<p>EXPLAIN ANALYSE<br>
SELECT id FROM &ldquo;product&rdquo; WHERE &ldquo;price&rdquo; &gt; 10<br>
ORDER BY store_id DESC<br>
LIMIT 1000</p>
<p>The query provided below is more “complex” as it has sorting and limiting in it and the query planner looks like this with no worker. Not only that the querying condition has changed as well resulting in more data to look for.</p>
<p><div class="not-prose">
<figure>
    <img src="/Users/nirjalpaudel/Downloads/me/posts/md_1717232175977/img/0__w2ZhiLEXbvCMUyos.jpg"
      alt="" 
      loading="lazy"
    >
  </figure></div>
</p>
<p>Here I forced the query planner to not use worker processes.</p>
<h4 id="planning-stage">Planning stage:</h4>
<p>The planning stage remains almost all the same with JIT enforced but here the parameters of the JIT is changed. Options like optimizations, and expressions are set to true. The overall number of functions is changed as well. Planning time is consistent.</p>
<h4 id="execution-stage">Execution stage:</h4>
<p>I forced only one worker to be used at this time. To see all the activities it performs, here parallel seq scan is used. Top-N heapsort is used, it shares the time complexity of heapsort but only sorts the top N members( for our case it’s 1000 ) and finally limit happens.</p>
<p>Now let’s add workers to the picture</p>
<p>Gather Merge node is used as it is expected to be used for queries with sorting enabled.</p>
<p>Here is the result for various query times.</p>
<p><div class="not-prose">
<figure>
    <img src="/Users/nirjalpaudel/Downloads/me/posts/md_1717232175977/img/1__xbJrtzyN__qk2xN1zbb9Qxg.png"
      alt="" 
      loading="lazy"
    >
  </figure></div>
</p>
<p>As you can see that using the worker process has significantly decreased the planning time by almost half compared to not being used in both queries. This is a general introduction to worker processes and JIT in Postgresql but do you still with 5 workers used, the query is considered really slow. This is due to the use of seq scan to filter the product table. In the next writing, I would help you on how to improve on that with an introduction to index in Postgres and its type. Until then, you can follow me on my LinkedIn here. <a href="https://linkedin.com/in/nirjalpaudel" target="_blank" rel="noopener">My Linkedin Profile</a>
.</p>

      </article>

      




    </div>
  </div>
</div>

  </main>
  <footer class="flex flex-none justify-center">
    <section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row">
    
  
  
    <a href="https://github.com/n1rjal" target="_blank" title="Github" class="flex flex-row mr-2">
      <span class="hidden">Github</span>
      <i class="h-6 w-6 flex-none"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path>
</svg>
 </i>
    </a>
  
  
  
    <a href="https://www.linkedin.com/in/nirjalpaudel/" target="_blank" title="LinkedIn" class="flex flex-row mr-2">
      <span class="hidden">LinkedIn</span>
      <i class="h-6 w-6 flex-none"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path>
   <path d="M8 11l0 5"></path>
   <path d="M8 8l0 .01"></path>
   <path d="M12 16l0 -5"></path>
   <path d="M16 16v-3a2 2 0 0 0 -4 0"></path>
</svg>
 </i>
    </a>
  
  


  </div>
  <div class="grow"></div>
  <div class="flex flex-row">
    <i class="h-6 w-6 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
   <path d="M14 9.75a3.016 3.016 0 0 0 -4.163 .173a2.993 2.993 0 0 0 0 4.154a3.016 3.016 0 0 0 4.163 .173"></path>
</svg>
</i> 2024 
    
  </div>
  
</section>

  </footer>
  <script src="/main.js"></script>




</body>
</html>
